---
- hosts: my_hosts
  vars_files:
  - vars.yml
  user: root
  pre_tasks:
  - name: Update APT repositories. 
    apt: update_cache=yes cache_valid_time=3600
  handlers:
  - name: restart apache
    service: name=apache2 state=restarted
  tasks:
  - name: Install Apache. 
    apt: name={{ item }} state=installed
       install_recommends=no
    with_items:
      - apache2
      - php5
  - name: Copy and extract dokuwiki files.
    unarchive:
      src: "{{ dokuwiki_file }}"
      dest: /var/www/
  - name: Rename dokuwiki directory.
    command: mv /var/www/"{{ dokuwiki_dirname }}" /var/www/dokuwiki
  - name: Setup necessary permissions for dokuwiki. 
    command: "{{item}}"
    with_items:
      - chown -R www-data:www-data /var/www/dokuwiki 
      - chmod 760 /var/www/dokuwiki 
      - find /var/www/dokuwiki/ -type d -exec chmod -c 0640 {} \; 
      - chmod -R ug+X /var/www/dokuwiki/ 
      - chmod -R g+w /var/www/dokuwiki/data/ /var/www/dokuwiki/conf/ /var/www/dokuwiki/lib/plugins/
  - name: Setup virtualhost for Dokuwiki. 
    template:
      src: "templates/dokuwiki.j2"
      dest: "/etc/apache2/sites-available/dokuwiki"
      owner: root
      group: root
      mode: 0644
    notify: restart apache
  - name: Disable Apache default site and enable dokuwiki site.
    command: "{{item}}"
    with_items:
      - a2dissite 000-default
      - a2ensite dokuwiki 
    notify: restart apache
